{% extends 'base.html' %}
{% block title %}Editar Receta Producto{% endblock %}
{% block content %}
<h2>Receta del Producto</h2>
{% if producto %}
  <p><strong>Producto:</strong> {{ producto.nombre }} (ID: {{ producto.id_producto }})</p>
{% else %}
  <p class="text-danger">Producto no encontrado.</p>
{% endif %}

<form method="post">
  {% csrf_token %}
  <table class="table" id="receta-table">
    <thead>
      <tr>
        <th>Insumo</th>
        <th>Cantidad Necesaria</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="receta-body">
      {% for linea in receta %}
        <tr>
          <td>
            <select name="insumo_id" class="form-select" required>
              <option value="">-- elegir --</option>
              {% for ins in insumos %}
                {% with ins_id=ins.id_insumo|default:ins.id %}
                  <option value="{{ ins_id }}" {% if ins_id == linea.id_insumo %}selected{% endif %}>{{ ins.nombre }} ({{ ins_id }})</option>
                {% endwith %}
              {% endfor %}
            </select>
          </td>
          <td><input type="number" step="0.01" min="0" name="cantidad" value="{{ linea.cantidad_necesaria }}" class="form-control" required></td>
          <td><button type="button" class="btn btn-sm btn-danger btn-remove">X</button></td>
        </tr>
      {% endfor %}
      {% if receta|length == 0 %}
        <tr>
          <td>
            <select name="insumo_id" class="form-select" required>
              <option value="">-- elegir --</option>
              {% for ins in insumos %}
                {% with ins_id=ins.id_insumo|default:ins.id %}
                  <option value="{{ ins_id }}">{{ ins.nombre }} ({{ ins_id }})</option>
                {% endwith %}
              {% endfor %}
            </select>
          </td>
          <td><input type="number" step="0.01" min="0" name="cantidad" value="" class="form-control" required></td>
          <td><button type="button" class="btn btn-sm btn-danger btn-remove">X</button></td>
        </tr>
      {% endif %}
    </tbody>
  </table>
  <button type="button" id="add-line" class="btn btn-secondary">Agregar línea</button>
  <button type="submit" class="btn btn-primary">Guardar Receta</button>
</form>

{% if costo_breakdown %}
<hr>
<h3>Costo de la Receta</h3>
<table class="table table-sm">
  <thead>
    <tr>
      <th>Insumo</th>
      <th>Cantidad</th>
      <th>Costo Unitario</th>
      <th>Costo Línea</th>
    </tr>
  </thead>
  <tbody>
  {% for linea in costo_breakdown %}
    <tr>
      <td>{{ linea.id_insumo }}</td>
      <td>{{ linea.cantidad }}</td>
      <td>
        {% if linea.costo_unitario is not None %}
          ${{ linea.costo_unitario|floatformat:2 }}
        {% else %}—{% endif %}
      </td>
      <td>
        {% if linea.costo_linea is not None %}
          ${{ linea.costo_linea|floatformat:2 }}
        {% else %}—{% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <th colspan="3" class="text-end">Costo Total Receta:</th>
      <th>{% if costo_receta is not None %}${{ costo_receta|floatformat:2 }}{% else %}—{% endif %}</th>
    </tr>
  </tfoot>
</table>
<p class="text-muted small">Costo unitario calculado como promedio ponderado (subtotal/cantidad) de las últimas compras registradas por insumo.</p>
{% endif %}

<script>
(function(){
  const tbody = document.getElementById('receta-body');
  const addBtn = document.getElementById('add-line');
  addBtn.addEventListener('click', () => {
    const tpl = document.createElement('tr');
    tpl.innerHTML = `
      <td>
        <select name="insumo_id" class="form-select" required>
          <option value="">-- elegir --</option>
          {% for ins in insumos %}
            {% with ins_id=ins.id_insumo|default:ins.id %}
              <option value="{{ ins_id }}">{{ ins.nombre }} ({{ ins_id }})</option>
            {% endwith %}
          {% endfor %}
        </select>
      </td>
      <td><input type="number" step="0.01" min="0" name="cantidad" class="form-control" required></td>
      <td><button type="button" class="btn btn-sm btn-danger btn-remove">X</button></td>
    `;
    tbody.appendChild(tpl);
  });
  tbody.addEventListener('click', (e) => {
    if(e.target.classList.contains('btn-remove')){
      const row = e.target.closest('tr');
      row && row.remove();
    }
  });
})();
</script>
{% endblock %}
